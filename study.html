<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Zone | Student Hub</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">Student<span style="color: var(--accent)">Hub</span></div>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="tasks.html">Tasks</a>
                <a href="study.html" class="active">Study</a>
                <a href="reflections.html">Reflections</a>
                <a href="flashcards.html">Flashcards</a>
            </div>
            <button onclick="Backend.logout()" class="btn"
                style="padding: 0.5rem 1rem; font-size: 0.9rem; background: rgba(255,255,255,0.1);">Logout</button>
        </div>
    </nav>

    <div class="container fade-in">
        <h1 style="text-align: center; margin-bottom: 2rem;">Focus Mode</h1>

        <div class="centered-layout" style="margin-bottom: 3rem;">
            <div class="card" style="text-align: center; width: 100%; max-width: 500px; padding: 3rem;">
                <div id="timerDisplay"
                    style="font-size: 5rem; font-weight: 800; font-variant-numeric: tabular-nums; line-height: 1;">00:00
                </div>
                <p id="timerStatus" style="color: var(--text-muted); margin-bottom: 2rem;">Ready to focus?</p>

                <div style="margin-bottom: 1.5rem;">
                    <input type="text" id="studySubject" placeholder="What are you studying?"
                        style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--glass-border); background: #020617; color: white; width: 200px; text-align: center;">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button id="startBtn" onclick="startSession()" class="btn" style="width: 120px;">Start</button>
                    <button id="stopBtn" onclick="stopSession()" class="btn"
                        style="background: #ef4444; width: 120px; display: none;">Stop & Save</button>
                </div>
            </div>
        </div>

        <h2 style="margin-bottom: 1.5rem;">Recent Sessions</h2>
        <div id="sessionList" class="grid">
            <!-- Sessions will load here -->
        </div>
    </div>

    <script type="module">
        import { Backend } from './app.js';

        let startTime = null;
        let timerInterval = null;

        window.startSession = () => {
            const subject = document.getElementById('studySubject').value;
            if (!subject) {
                alert("Please enter a subject!");
                return;
            }

            startTime = new Date();
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('timerStatus').textContent = `Studying ${subject}...`;
            document.getElementById('studySubject').disabled = true;

            timerInterval = setInterval(updateTimer, 1000);
        };

        window.stopSession = async () => {
            clearInterval(timerInterval);
            const endTime = new Date();
            const subject = document.getElementById('studySubject').value;

            try {
                await Backend.saveStudySession(subject, startTime.toISOString(), endTime.toISOString());
                resetUI();
                loadSessions();
            } catch (err) {
                alert(err.message);
            }
        };

        function updateTimer() {
            const now = new Date();
            const diff = now - startTime;
            const date = new Date(diff);
            const m = date.getUTCMinutes().toString().padStart(2, '0');
            const s = date.getUTCSeconds().toString().padStart(2, '0');
            document.getElementById('timerDisplay').textContent = `${m}:${s}`;
        }

        function resetUI() {
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('timerStatus').textContent = "Ready to focus?";
            document.getElementById('timerDisplay').textContent = "00:00";
            document.getElementById('studySubject').disabled = false;
            document.getElementById('studySubject').value = '';
        }

        async function loadSessions() {
            try {
                const sessions = await Backend.getUserStudySessions();
                const list = document.getElementById('sessionList');
                list.innerHTML = '';

                // Sort by time descending
                sessions.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

                sessions.forEach(s => {
                    const el = document.createElement('div');
                    el.className = 'card';
                    el.innerHTML = `
                   <div style="color: var(--success); font-weight: bold;">${s.subject}</div>
                   <div style="font-size: 2rem; font-weight: 800;">${s.durationMinutes}m</div>
                   <div style="color: var(--text-muted); font-size: 0.85rem;">${new Date(s.startTime).toLocaleDateString()}</div>
                `;
                    list.appendChild(el);
                });
            } catch (e) {
                console.error(e);
            }
        }

        loadSessions();
    </script>
</body>

</html>